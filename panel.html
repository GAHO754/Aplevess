<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel</title>
  <link rel="icon" type="image/png" sizes="32x32" href="manzanas.png">
  <link rel="stylesheet" href="registrar.css" />

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    .dashboard { max-width: 980px; margin: 110px auto 60px; padding: 16px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 12px; margin-bottom: 18px; }
    .stat { background: rgba(25,25,25,.7); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px; }
    .stat h4 { margin-bottom: 6px; color:#ffd4d4; }
    table { width:100%; border-collapse: collapse; font-size:14px; background: rgba(25,25,25,.6); border:1px solid rgba(255,255,255,.08); border-radius:12px; overflow: hidden; }
    th, td { padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); }
    th { text-align:left; color:#ffd4d4; }
    .chip-exp { padding:4px 8px; border-radius:999px; font-weight:700; }
    .ok { color:#9be49b; }
    .warn { color:#ffdfaa; }
    .err { color:#ff9a9a; }
    .right-section .btn-logout { margin-left: 8px; padding: 10px 16px; }
    .video-card { margin-top: 22px; background: rgba(25,25,25,.7); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; }
    .video-card h3 { margin-bottom: 10px; color:#ffd4d4; }
    .video-wrap { width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 12px; overflow: hidden; border:1px solid rgba(255,255,255,.08); }
    .video-wrap video, .video-wrap iframe { width: 100%; height: 100%; display: block; object-fit: cover; background: #000; }
    .redeem-wrap{ display: flex; justify-content: center; align-items: center; margin: 16px 0 24px; }
    a { text-decoration: none; }
    a:hover { text-decoration: none; }
  </style>
</head>
<body class="bg-animated">
  <header class="top-bar">
    <div class="left-section"><h1 class="applebees-title">Applebee‚Äôs</h1></div>
    <div class="center-section"><p id="userGreeting">Panel</p></div>
    <div class="right-section">
      <a class="btn-secondary" href="registrar.html">+ Registrar ticket</a>
      <button id="btnLogout" class="btn-cta btn-logout" type="button">Salir</button>
    </div>
  </header>

  <main class="dashboard">
    <section class="stats">
      <div class="stat">
        <h4>üéüÔ∏è Tickets cargados</h4>
        <div><strong id="statTickets">0</strong></div>
      </div>
      <div class="stat">
        <h4>üìç Visitas realizadas</h4>
        <div><strong id="statVisitas">0</strong></div>
      </div>
      <div class="stat">
        <h4>‚≠ê Puntos disponibles</h4>
        <div><strong id="statPuntosActivos">0</strong> pts</div>
        <small class="warn" id="statPuntosProx"></small>
        <small class="warn" id="statPuntosDetalle"></small>
      </div>
      <div class="stat">
        <h4>‚è≥ Puntos vencidos</h4>
        <div><strong id="statPuntosVencidos">0</strong> pts</div>
      </div>
    </section>

    <h3 style="margin:10px 0 8px;">Historial de consumos</h3>
    <table id="tablaTickets">
      <thead>
        <tr>
          <th># Ticket</th>
          <th>Fecha</th>
          <th>Total</th>
          <th>Puntos</th>
          <th>Vence</th>
          <th>Estatus</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="redeem-wrap">
      <a class="btn-cta btn-redeem" href="canjear.html">Canjear puntos</a>
    </div>

    <section class="video-card hero">
      <h3>Promociones para ti</h3>
      <div class="video-wrap banner-349">
        <video id="promoVideo" autoplay muted playsinline loop preload="auto" poster="assets/poster.jpg">
          <source src="Video-Web-Header-R3.mp4" type="video/mp4" />
        </video>
      </div>
    </section>
  </main>

  <script>
    // ====== RTDB ======
    const auth = firebase.auth();
    const db   = firebase.database();
    const $ = (id)=>document.getElementById(id);
    const tbody = document.querySelector('#tablaTickets tbody');
    const VENCE_EN_DIAS = 180;

    document.getElementById('btnLogout').addEventListener('click', async () => {
      try { await auth.signOut(); location.href = 'index.html'; }
      catch (e) { console.error('Error al cerrar sesi√≥n:', e); alert('No se pudo cerrar sesi√≥n.'); }
    });

    function fmtDate(millis) {
      if (!millis) return '';
      const d = new Date(millis);
      return d.toLocaleDateString('es-MX', { year:'numeric', month:'2-digit', day:'2-digit' });
    }
    function daysLeft(millis) {
      if (!millis) return -1;
      return Math.ceil((millis - Date.now()) / 86400000);
    }

    let _tickets = [];
    let _redemptions = [];

    function renderTableAndTicketStats() {
      let totalTickets=0, visitas=0, ptsActivosTickets=0, ptsVencidos=0, proximos=[];

      const rowsHtml = _tickets.map(t=>{
        totalTickets++; visitas++;
        const pts = Number(t.puntos || 0);

        const left = t.vencePuntos ? daysLeft(t.vencePuntos) : -1;
        let estatus;
        if (!t.vencePuntos || left < 0) {
          ptsVencidos += pts; estatus = '<span class="chip-exp err">Vencido</span>';
        } else {
          ptsActivosTickets += pts;
          estatus = '<span class="chip-exp ok">Activo</span>';
          if (left<=14 && pts>0) proximos.push({pts,left});
        }

        return `
          <tr>
            <td>${t.numero || t.folio || ''}</td>
            <td>${t.fecha ? t.fecha.split('-').reverse().join('/') : fmtDate(t.createdAt)}</td>
            <td>$${Number(t.total||0).toFixed(2)}</td>
            <td>${pts}</td>
            <td>${fmtDate(t.vencePuntos)}</td>
            <td>${estatus}</td>
          </tr>`;
      }).join('');

      tbody.innerHTML = rowsHtml || `<tr><td colspan="6" class="warn">Sin tickets a√∫n.</td></tr>`;

      $('statTickets').textContent = totalTickets;
      $('statVisitas').textContent = visitas;
      $('statPuntosVencidos').textContent = ptsVencidos;

      window.__ptsActivosTickets = ptsActivosTickets;
      window.__proximos = proximos;
      updateHeaderStats();
    }

    function updateHeaderStats() {
      const ptsActivosTickets = window.__ptsActivosTickets || 0;
      const proximos = window.__proximos || [];
      const now = Date.now();

      const spentByRedeemed = _redemptions
        .filter(r => r.status === 'canjeado')
        .reduce((a,r)=> a + (Number(r.cost)||0), 0);

      const reservedPending = _redemptions
        .filter(r => r.status === 'pendiente')
        .filter(r => !r.expiresAt || r.expiresAt > now)
        .reduce((a,r)=> a + (Number(r.cost)||0), 0);

      const disponibles = Math.max(0, ptsActivosTickets - spentByRedeemed - reservedPending);
      $('statPuntosActivos').textContent = disponibles;
      $('statPuntosProx').textContent = proximos.length
        ? `‚ö†Ô∏è ${proximos.reduce((a,b)=>a+b.pts,0)} pts vencen en ~${Math.min(...proximos.map(p=>p.left))} d√≠a(s).`
        : '';
      $('statPuntosDetalle').textContent =
        (reservedPending>0 || spentByRedeemed>0)
        ? `Reservados: ${reservedPending} pts ¬∑ Canjeados: ${spentByRedeemed} pts`
        : '';
    }

    function showError(msg) {
      console.error(msg);
      tbody.innerHTML = `<tr><td colspan="6" class="err">${msg}</td></tr>`;
    }

    auth.onAuthStateChanged((user) => {
      if (!user) {
        $('userGreeting').textContent = "Inicia sesi√≥n";
        showError("No hay sesi√≥n activa.");
        return;
      }
      $('userGreeting').textContent = `Hola, ${user.displayName||user.email}`;

      const tRef = db.ref(`users/${user.uid}/tickets`);
      tRef.on('value', (snap) => {
        const val = snap.val() || {};
        _tickets = Object.values(val).map(t => {
          const puntosNorm = (
            (t.puntos && typeof t.puntos === 'object' ? Number(t.puntos.total || 0) : Number(t.puntos || 0)) ||
            Number(t.puntosTotal || 0) ||
            Number(t.points || 0)
          );
          const createdAt = Number(t.createdAt || 0);
          const vencePuntos = t.vencePuntos
            ? Number(t.vencePuntos)
            : (createdAt ? createdAt + VENCE_EN_DIAS * 86400000 : null);
          return {
            ...t,
            total: Number(t.total || 0),
            puntos: puntosNorm,
            createdAt,
            vencePuntos
          };
        });
        _tickets.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
        renderTableAndTicketStats();
      }, (err) => showError("Error leyendo tickets: " + err.message));

      const rRef = db.ref(`users/${user.uid}/redemptions`);
      rRef.on('value', (snap) => {
        const val = snap.val() || {};
        _redemptions = Object.values(val).map(r => ({
          ...r,
          cost: Number(r.cost || 0),
          createdAt: Number(r.createdAt || 0),
          expiresAt: r.expiresAt ? Number(r.expiresAt) : null,
          status: String(r.status || '').toLowerCase()
        }));
        updateHeaderStats();
      }, (err) => console.error("Error leyendo redemptions:", err));
    });

    (function(){
      const v = document.getElementById('promoVideo');
      if(!v) return;
      function tryPlay(){ v.play().catch(()=>{}); }
      v.addEventListener('loadedmetadata', tryPlay);
      v.addEventListener('canplay', tryPlay);
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) tryPlay(); });
      window.addEventListener('focus', tryPlay);
    })();
  </script>
</body>
</html>
